<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\CSA_LatinHack.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> CSA_LatinHack.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>36/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>44/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>14/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>47/47</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">38×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-yes">22×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;
&nbsp;
/**
 * @title CSA_LatinHack
 * @author Equipo de desarrollo de E-co.lab
 * @notice Contrato prototipo para una Agricultura Sostenida por la Comunidad (CSA)
 * que utiliza NFTs (RWA) para representar las participaciones de los miembros.
 */
contract CSA_LatinHack {
&nbsp;
    // --- Variables de Estado ---
&nbsp;
    // Lógica de propiedad
    address public owner;
&nbsp;
    // Estructuras de datos principales de ERC-1155
    // id del token =&gt; propietario =&gt; balance
    mapping(uint256 =&gt; mapping(address =&gt; uint256)) private _balances;
    // propietario =&gt; operador =&gt; aprobado (true/false)
    mapping(address =&gt; mapping(address =&gt; bool)) private _operatorApprovals;
&nbsp;
    // Datos específicos del negocio
    struct Season {
        string name;
        uint256 membershipPrice;
        uint256 totalMemberships;
        uint256 soldMemberships;
        uint256 startTime;
        uint256 endTime;
        bool isOpenForSale;
    }
    // El índice del array es ahora el ID del token para la temporada
    Season[] public seasons;
&nbsp;
    // Mapeo para el canje semanal: miembro =&gt; id de temporada =&gt; número de semana =&gt; canjeado
    mapping(address =&gt; mapping(uint256 =&gt; mapping(uint256 =&gt; bool))) public weeklyRedemptions;
&nbsp;
    // --- Eventos ---
&nbsp;
    // Eventos estándar de ERC-1155
    event TransferSingle(address indexed _operator, address indexed _from, address indexed _to, uint256 _id, uint256 _amount);
    event ApprovalForAll(address indexed _owner, address indexed _operator, bool _approved);
&nbsp;
    // Eventos personalizados del negocio
    event SeasonCreated(uint256 seasonId, string name, uint256 price, uint256 capacity);
    event MembershipPurchased(uint256 seasonId, address member, uint256 amount);
    event BoxRedeemed(uint256 seasonId, address member, uint256 weekNumber);
&nbsp;
    // --- Modificadores ---
&nbsp;
    modifier onlyOwner() {
        require(owner == msg.sender, "CSA: Quien llama no es el propietario");
        _;
    }
&nbsp;
    // --- Constructor ---
&nbsp;
    constructor(address initialOwner) {
        owner = initialOwner;
    }
&nbsp;
    // --- Lógica Principal del Negocio ---
&nbsp;
    function createNewSeason(string memory seasonName, uint256 price, uint256 capacity, uint256 durationInWeeks) external onlyOwner {
        uint256 startTime = block.timestamp;
        uint256 endTime = startTime + (durationInWeeks * 1 weeks);
        
        seasons.push(Season({
            name: seasonName,
            membershipPrice: price,
            totalMemberships: capacity,
            soldMemberships: 0,
            startTime: startTime,
            endTime: endTime,
            isOpenForSale: true
        }));
        
        uint256 seasonId = seasons.length - 1;
        emit SeasonCreated(seasonId, seasonName, price, capacity);
    }
&nbsp;
    function closeSeasonSales(uint256 seasonId) external onlyOwner {
        require(seasonId &lt; seasons.length, "CSA: ID de temporada invalido");
        seasons[seasonId].isOpenForSale = false;
    }
&nbsp;
    function buyMembership() external payable {
        require(seasons.length &gt; 0, "CSA: No hay temporadas creadas");
        uint256 seasonId = seasons.length - 1; // Compra siempre de la última temporada creada
                
        Season storage currentSeason = seasons[seasonId];
&nbsp;
        require(currentSeason.isOpenForSale, "CSA: Las ventas estan cerradas");
        require(currentSeason.soldMemberships &lt; currentSeason.totalMemberships, "CSA: Todas las participaciones vendidas");
        require(msg.value == currentSeason.membershipPrice, "CSA: Monto enviado incorrecto");
&nbsp;
        currentSeason.soldMemberships++;
        
        // Acuña 1 token del tipo 'seasonId' para el comprador
        _mint(msg.sender, seasonId, 1);
        
        emit MembershipPurchased(seasonId, msg.sender, 1);
    }
&nbsp;
    function redeemWeeklyBox(uint256 seasonId) external {
        // El usuario debe poseer al menos una participación de esta temporada
        require(balanceOf(msg.sender, seasonId) &gt;= 1, "CSA: No eres miembro de esta temporada");
        
        Season storage season = seasons[seasonId];
&nbsp;
        require(block.timestamp &gt;= season.startTime &amp;&amp; block.timestamp &lt;= season.endTime, "CSA: Fuera del periodo de la temporada");
&nbsp;
        uint256 currentWeek = (block.timestamp - season.startTime) / 1 weeks;
&nbsp;
        // La lógica de canje ahora está vinculada a la dirección del miembro y al id de la temporada
        require(!weeklyRedemptions[msg.sender][seasonId][currentWeek], "CSA: La caja de esta semana ya fue canjeada");
&nbsp;
        weeklyRedemptions[msg.sender][seasonId][currentWeek] = true;
        emit BoxRedeemed(seasonId, msg.sender, currentWeek);
    }
    
    function withdraw() external onlyOwner {
        (bool success, ) = owner.call{value: address(this).balance}("");
        require(success, "CSA: El retiro fallo");
    }
&nbsp;
    // --- Implementación Mínima de ERC-1155 ---
&nbsp;
    function balanceOf(address account, uint256 id) public view returns (uint256) {
        require(account != address(0), "ERC1155: direccion invalida");
        return _balances[id][account];
    }
&nbsp;
    function setApprovalForAll(address operator, bool approved) public {
        _operatorApprovals[msg.sender][operator] = approved;
        emit ApprovalForAll(msg.sender, operator, approved);
    }
&nbsp;
    function isApprovedForAll(address account, address operator) public view returns (bool) {
        return _operatorApprovals[account][operator];
    }
&nbsp;
    function safeTransferFrom(address from, address to, uint256 id, uint256 amount, bytes memory data) public {
        require(from == msg.sender || isApprovedForAll(from, msg.sender), "ERC1155: no autorizado");
        require(to != address(0), "ERC1155: no se puede transferir a la direccion cero");
        require(_balances[id][from] &gt;= amount, "ERC1155: balance insuficiente");
&nbsp;
        _balances[id][from] -= amount;
        _balances[id][to] += amount;
&nbsp;
        emit TransferSingle(msg.sender, from, to, id, amount);
        
        // NOTA: Se omite la llamada de verificación onERC1155Received para ahorrar bytecode.
    }
&nbsp;
    function burn(address from, uint256 id, uint256 amount) public {
        require(from == msg.sender, "ERC1155: solo el propietario puede quemar");
        require(_balances[id][from] &gt;= amount, "ERC1155: balance insuficiente para quemar");
&nbsp;
        _balances[id][from] -= amount;
        emit TransferSingle(msg.sender, from, address(0), id, amount);
    }
&nbsp;
    function _mint(address to, uint256 id, uint256 amount) internal {
        require(to != address(0), "ERC1155: no se puede acunar a la direccion cero");
        _balances[id][to] += amount;
        emit TransferSingle(msg.sender, address(0), to, id, amount);
    }
&nbsp;
    function transferOwnership(address newOwner) external onlyOwner {
        owner = newOwner;
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 03 2025 22:24:34 GMT-0300 (Horário Padrão de Brasília)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
